#!/bin/bash

START_TIME=$(date +%s)

echo "  
 
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 
                                                                                                                                          
"

handle_error() {
    echo "‚ùå $1"
    exit 1
}

echo "Iniciando FLUXO-CERTO..."
echo "Verifica√ß√£o de depend√™ncias do sistema..."

# Instala√ß√£o do Java em paralelo
instalar_java() {
    echo "üîß Verificando se o Java est√° instalado..."
    if type -p java > /dev/null; then
        echo "‚úÖ Java j√° est√° instalado!"
    else
        echo "‚è≥ Java n√£o encontrado. Instalando..."
        sudo apt install -y openjdk-21-jdk
        echo "‚úÖ Java instalado com sucesso!"
    fi
}

# Instala√ß√£o do Docker
instalar_docker() {
    echo "üîß Verificando se o Docker est√° instalado..."
    if command -v docker > /dev/null 2>&1; then
        echo "‚úÖ Docker j√° est√° instalado!"
    else
        echo "‚è≥ Instalando Docker..."
        sudo apt install -y docker.io
        echo "‚úÖ Docker instalado com sucesso!"
    fi

    echo "üöÄ Iniciando servi√ßo do Docker..."
    sudo systemctl start docker
    sudo systemctl enable docker
}

# Instala√ß√£o do Docker Compose
instalar_docker_compose() {
    echo "üîß Verificando se o Docker Compose est√° instalado..."
    if command -v docker-compose > /dev/null 2>&1; then
        echo "‚úÖ Docker Compose j√° est√° instalado!"
    else
        echo "‚è≥ Instalando Docker Compose..."
        sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        echo "‚úÖ Docker Compose instalado com sucesso!"
    fi

    echo "üì¶ Vers√£o do Docker Compose:"
    sudo docker-compose version
}

# Subir containers com Docker Compose
start_containers() {
    echo "üöÄ Iniciando containers com Docker Compose..."
    sudo docker-compose up -d || { echo "‚ùå Falha ao iniciar os containers!"; exit 1; }
    echo "‚úÖ Todos os containers foram iniciados com sucesso!"
}

# Aguardar o MySQL estar acess√≠vel
esperar_mysql() {
    echo "‚è≥ Aguardando o MySQL iniciar (pode levar alguns segundos)..."
    until sudo docker exec container-bd mysqladmin ping -h"localhost" -uroot -purubu100 --silent; do
        printf "."
        sleep 2
    done
    echo "‚úÖ MySQL est√° pronto para conex√µes!"
}

# Iniciar instala√ß√£o do Java em paralelo
instalar_java &

# Fluxo sequencial: Docker ‚Üí Compose ‚Üí Containers
instalar_docker
instalar_docker_compose
start_containers
esperar_mysql

# Esperar instala√ß√£o do Java, se ainda estiver rodando
wait



echo "‚úÖ Ambiente FLUXO-CERTO preparado com sucesso!"

echo ""
echo "==============================================================================="
echo ""


echo "üöÄ Iniciando configura√ß√£o de rede e proxy reverso..."

esperar_liberacao_apt() {
    echo "‚è≥ Aguardando libera√ß√£o do APT..."
    while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 ; do
        sleep 2
    done
}

esperar_liberacao_apt

echo "üì¶ Instalando o Nginx..."
sudo apt install nginx -y || handle_error "ERRO AO INSTALAR O NGINX"

echo "üîß Criando configura√ß√£o do Nginx para fluxocerto.duckdns.org..."
sudo bash -c 'cat > /etc/nginx/sites-available/fluxocerto <<EOF
server {
    listen 80;
    server_name fluxocerto.duckdns.org;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
EOF' || handle_error "ERRO AO CRIAR O ARQUIVO DE CONFIGURA√á√ÉO DO NGINX"

echo "üîó Ativando o site e removendo o default..."
sudo ln -sf /etc/nginx/sites-available/fluxocerto /etc/nginx/sites-enabled/fluxocerto || handle_error "ERRO AO ATIVAR O SITE"
sudo rm -f /etc/nginx/sites-enabled/default || handle_error "ERRO AO REMOVER O SITE PADR√ÉO"

echo "üß™ Testando configura√ß√£o do Nginx..."
sudo nginx -t || handle_error "CONFIGURA√á√ÉO INV√ÅLIDA DO NGINX"

echo "üîÑ Reiniciando o Nginx..."
sudo systemctl restart nginx || handle_error "ERRO AO REINICIAR O NGINX"

echo "‚úÖ Proxy reverso configurado com sucesso!"


echo ""
echo "==============================================================================="
echo ""

echo "Iniciando o processo de ETL..."
# ETL
echo "Copiando o arquivo JAR que est√° no docker para dentro da inst√¢ncia..."
sudo docker cp container_fluxocerto:/usr/src/app/java/extracao-dados/target/extracaoDados.jar ./extracaoDados.jar

echo "Executando o JAR"
java -jar extracaoDados.jar

echo "Tratamento de dados foi um sucesso!"

echo ""
echo "==============================================================================="
echo ""


echo "  
 
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 
                                                      
"
echo "‚úÖ Sua aplica√ß√£o est√° rodando com sucesso!"
IP=$(curl -s http://checkip.amazonaws.com)
echo ""
echo "üåê Acesse a aplica√ß√£o rodando em: http://fluxocerto.duckdns.org/"
echo ""
echo ""
echo ""
echo "üîç Testando conex√£o..."
if curl -s --head --request GET "http://$IP:8080" | grep "200 OK" > /dev/null; then
    echo "‚úÖ Conex√£o bem-sucedida! Tudo certo!"
else
    echo "‚ö†Ô∏è Aten√ß√£o: N√£o foi poss√≠vel validar a conex√£o automaticamente."
    echo "   Verifique se os containers est√£o rodando ou tente novamente em alguns segundos."
fi

# Mostrar o tempo total
END_TIME=$(date +%s)
ELAPSED_TIME=$((END_TIME - START_TIME))

echo ""
echo "‚è±Ô∏è Tempo total de prepara√ß√£o: ${ELAPSED_TIME} segundos."
echo ""
echo "==============================================================================="
